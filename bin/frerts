#!/usr/bin/perl
# -*- cperl -*-
# $Id: frerts,v 15.1.2.27 2010/08/24 20:25:25 fms Exp $
# ------------------------------------------------------------------------------
# FMS/FRE Project: Automated launch of fremake, frerun and frecheck.
# ------------------------------------------------------------------------------
# Copyright (C) NOAA Geophysical Fluid Dynamics Laboratory, 2000-2010
# Designed and written by V. Balaji, Amy Langenhorst and Aleksey Yakovlev


use strict;
use Getopt::Long(':config', 'no_ignore_case');
use XML::LibXML;
use FRE();
use FREExperiment();
use lib (File::Basename::fileparse(File::Spec->rel2abs($0)))[1] . "../lib";
use Date::Manip();


{
package frerts;

use constant VERSION => '$Id: frerts,v 15.1.2.27 2010/08/24 20:25:25 fms Exp $';
use constant OPTLIST =>
  (
      'help|h',
      'datestr|d=s',
      'execute|e',
      'platform|Platform|P=s',
      'regtype|r=s',
      'submit|s',
      'verbose|v',
      'xmlfile|x=s'
  );
}

{
#get a datestring to use to create a unique path
my $thisdate = `date '+%Y%m%d_%H%M%S'`;
chomp $thisdate;

#get options
my %opt = (
     'datestr'   => $thisdate,
     'platform'  => FREDefaults::Platform(),
     'regtype'   => 'suite',
     'xmlfile'   => FREDefaults::XMLFile()
  );
Getopt::Long::GetOptions(\%opt,frerts::OPTLIST) or die "FATAL: can't parse command line options\n";

my $xmlfile = '';
if ( $ARGV[0] and "$opt{xmlfile}" eq FREDefaults::XMLFile() ) {
   if ( -f $ARGV[0] ) {
      $xmlfile = File::Spec->rel2abs($ARGV[0]);
   } elsif ( -f "$ENV{FRE_XML_HOME}/$ARGV[0]") {
      $xmlfile = File::Spec->rel2abs($ENV{FRE_XML_HOME}/$ARGV[0]);
   } else {
      print "FATAL: XML file does not exist: '$ARGV[0]'\n";
      $opt{help}=1;
   }
} elsif ( -f $opt{xmlfile} ) {
   $xmlfile = File::Spec->rel2abs($opt{xmlfile});
} elsif ( defined $ENV{FRE_XML_HOME} and -f "$ENV{FRE_XML_HOME}/$opt{xmlfile}" ) {
   $xmlfile = "$ENV{FRE_XML_HOME}/$opt{xmlfile}";
} elsif (! $opt{help} ) {
  print "FATAL: XML file does not exist: '$opt{xmlfile}'\n";
  $opt{help}=1;
}
$opt{xmlfile} = $xmlfile;
my $xml = $xmlfile;
$xml =~ s/.*\///;

#help message
if( $opt{help} ) {
   print <<EOF;

Synopsis: Creates a script to launch fremake, frerun and frecheck automatically.
          All the experiments in the xml file will be compiled, and the suite
          of regression tests (all basic, restarts, and scaling regression 
          runs) will be run.  Then frecheck will be called.  Source, executables,
          and stdout will be written to \$HOME/autoRTS/date-string/.
          This tool does not take an experiment name.

Usage: frerts [ options ]
       -d STR, --datestr=STR   Optional string to use in output directory paths.
                               Default is a unique date string.
       -h,     --help          Show this help message, then exit.
       -p STR, --platform=STR  Platform. GFDL site default is hpcs.hpcs.
       -s,     --submit        Automatically submit the script with qsub.
       -v,     --verbose       Verbose flag.
       -x STR, --xmlfile=STR   Specify xml file. Default is ./rts.xml.

Example: frerts -x fv_am2.xml

EOF
   exit 1;
}
#       -r STR, --regtype=STR   Regression type. STR can be "basic" or "suite".

#get root node of xml file
my $fre = FRE->new('frerts', %opt) or exit(1);
my $root = $fre->{rootNode};
my $autoRTSroot = $fre->property('FRE.autoRTS.root.prefix');

#get info for script...
my $rtsstdoutdir = "$autoRTSroot/$opt{datestr}";
print "Stdoutdir: $rtsstdoutdir\n" if $opt{verbose};
print "Using xml file $xmlfile\n" if $opt{verbose};
mkdir "$autoRTSroot" if not -d "$autoRTSroot";

#platform csh
my $platformcsh = $root->findvalue("setup/platform[\@name='$opt{platform}']/csh");

#ttlruntime=2hrs for compiles+sum of regression test times
#npes=max pes used in regression tests in file
my $ttlruntime = '0';
my $npes = '0';
my $err;

#get max npes and total runtime from regression nodes
my $regxpath = "\@name='basic' or \@label='basic'";
if ( $opt{regtype} eq "suite" ) {
   $regxpath .= " or \@name='scaling' or \@label='scaling' or \@name='restarts' or \@label='restarts'";
}
#print "Using $regxpath\n" if $opt{verbose};
print "Calculating total npes/runtime ...\n" if $opt{verbose};

my @regnodes = $root->findnodes("experiment/runtime/regression[$regxpath]/run");
foreach my $node ( @regnodes ) {
  my $runnpes = $node->findvalue('@npes');
  if ( $runnpes > $npes ) { $npes = $runnpes; }

  my $runtime = $node->findvalue('@runTimePerJob');
  $ttlruntime = Date::Manip::DateCalc($ttlruntime,'+'."$runtime",\$err);
  if ( "$err" ne "" ) { print STDERR "ERROR: DateCalc: $err\n"; }

  if ($opt{verbose}) {
     my $runregname = $node->findvalue('../@name');
        $runregname = $node->findvalue('../@label') if ("$runregname" eq '');
     my $runexpt = $node->findvalue('../../../@name');
     my $tmpttlruntime = $ttlruntime;
     $tmpttlruntime =~ s/^\+0:0:0://;
     print "  $runexpt $runregname run: $runnpes/$runtime  (Total: $npes/$tmpttlruntime)\n";
  }
}

#how to count compiles...? for now, randomly add 2 hours?
#$ttlruntime = Date::Manip::DateCalc($ttlruntime,'+ 2 hours',\$err);
if ( "$err" ne "" ) { print STDERR "ERROR: DateCalc: $err\n"; }

if ( $ttlruntime =~ m/^\+0:0:0:0:/ ) {
   $ttlruntime =~ s/^\+0:0:0:0:(\d+):/$1:/;
   die "FATAL: This test will take more than 16 hours. ($1 hours)\n       Please remove some experiments from the xml file to use frerts with it.\n" if ( $1 > 16 );
} else {
   die "FATAL: This test will take more than 16 hours. (more than 24 hours)\n       Please remove some experiments from the xml file to use frerts with it.\n";
}

print "Total npes: $npes\n" if $opt{verbose};
print "Total runtime: $ttlruntime\n" if $opt{verbose};

if ( $npes > 40 and not $opt{submit} ) {
   print "WARNING: This script uses $npes processors. It is too large to be\n";
   print "         run interactively on ic0.  Please use 'frerts -s'.\n";
}

#set csh script content

my $schedprefix = $fre->property('FRE.scheduler.prefix');
my $schedcputime = $fre->property('FRE.scheduler.option.time');
my $schednpes = $fre->property('FRE.scheduler.option.npes');
my $schedstdout = $fre->property('FRE.scheduler.option.stdout');
my $schedcpuset = $fre->property('FRE.scheduler.option.cpuset');
my $schedrerun = $fre->property('FRE.scheduler.option.rerun');
my $schedname = $fre->property('FRE.scheduler.option.name');
my $schedjobid = $fre->property('FRE.scheduler.variable.jobID');
$schedcputime =~ s/\$//;
$schednpes =~ s/\$//;
$schedstdout = '-o '; #fre.properties doesn't allow specification of full path at DOE
                      #luckily this option is always -o. This should be changed in
                      #fre.properties to make it cleaner.
$schedname =~ s/\$//;

my $project = $fre->property('FRE.scheduler.project');
if ( "$project" ne '' ) {
   my $schedproject = $fre->property('FRE.scheduler.option.project');
   $schedproject =~ s/\$/$project/;
   $project = "$schedprefix $schedproject";
}

my $compiletime='02:00:00';
my $compilenpes=8;

my $mkscriptn = "autoRTS.mk.$thisdate.csh";
my $runscriptn = "autoRTS.run.$thisdate.csh";
my $mkscript = "$autoRTSroot/$opt{datestr}/$mkscriptn";
my $runscript = "$autoRTSroot/$opt{datestr}/$runscriptn";

my $mkcsh = <<EOF;
#!/bin/csh -f
# This automated regression test script was created by frerts.

$schedprefix $schedcputime$compiletime
$schedprefix $schednpes$compilenpes
$schedprefix $schedstdout$rtsstdoutdir/$mkscriptn.o\$$schedjobid
$schedprefix $schedname frerts-mk,$xml,$opt{datestr}
$schedprefix $schedcpuset
$schedprefix $schedrerun
$project
EOF

   my $runcsh = <<EOF;
#!/bin/csh -f
# This automated regression test script was created by frerts.

$schedprefix $schedcputime$ttlruntime
$schedprefix $schednpes$npes
$schedprefix $schedstdout$rtsstdoutdir/$runscriptn.o\$$schedjobid
$schedprefix $schedname frerts-run,$xml,$opt{datestr}
$schedprefix $schedcpuset
$schedprefix $schedrerun
$project
EOF

   my $vars = <<EOF;

set outdir = $rtsstdoutdir
set origxml = $xmlfile
set xml = $xml
set label = $opt{datestr}
set regtype = $opt{regtype}
set thisdate = $thisdate
set platform = $opt{platform}

#platform csh from xml
$platformcsh

EOF

my $batchvar = $fre->property('FRE.scheduler.variable.environment');
my $batchval = $fre->property('FRE.scheduler.variable.environment.value.batch');
my $runinter = <<EOF;
if ( \$mkstatus == 0 ) then
   if ( \$?$batchvar ) then
      if ( "\$$batchvar" != '$batchval' ) then
         $runscript
      endif
   else
      $runscript
   endif
else
   exit \$mkstatus
endif

EOF

   $mkcsh .= "$vars".getmktemplate()."$runinter";
   $runcsh .= "$vars".getruntemplate();

   #write script...
   print "Make script: $mkscript\n" if $opt{verbose};
   print "Run script: $runscript\n" if $opt{verbose};
   my $mkjob = writescript($mkcsh,$fre,$mkscript,"qsub",$opt{submit},$opt{verbose},0);

   if ( $mkjob ) {
      my $dependsOn = $fre->property('FRE.scheduler.option.dependsOn');
      $dependsOn =~ s/\$/$mkjob/;
      writescript($runcsh,$fre,$runscript,"qsub $dependsOn",$opt{submit},$opt{verbose},1);
   } else {
      die "Compile script submission failed, cannot submit runscript\n";
   }


}

#################################################################

sub getmktemplate {
   my $csh = <<'EOF';
if ( ! -f $origxml ) then
  echo FATAL: Cannot find xml file $origxml
  exit 1
endif

#set up temporary directory
if ( ! $?TMPDIR ) set TMPDIR = "$outdir"
set TMPDIR = "$TMPDIR/mk.tmp.$thisdate"
if ( -d $TMPDIR ) then
   rm -rf $TMPDIR/* >& /dev/null
else
   mkdir -p $TMPDIR
endif

cd $TMPDIR
echo Starting from $origxml
echo Temporary files in $TMPDIR

fretransform -d $label -p $platform -x $origxml > $xml

set list = ( `frelist -p $platform -x $xml |grep -v INHERITS` )
set list = ( $list `frelist -p $platform -x $xml |grep INHERITS |cut -f1 -d\ ` )
echo Experiments: $list

set rootdir = `frelist -p $platform -dir=root -t repro -x $xml $list[1]`
if ( ! -d $rootdir ) then
  mkdir -p $rootdir || exit 1
endif
cp $xml $rootdir
set mkstatus = 0

foreach expt ( $list )
  set cmd = "fremake -p $platform -t repro -x $xml $expt"
  set stdoutdir = `frelist -p $platform -dir=stdout -t repro -x $xml $expt`
  mkdir -p $stdoutdir
  set out = $stdoutdir/compile_$expt.stdout
  echo ---------------------------------------------------
  echo $cmd
  $cmd >& $out
  set mystatus = $status
  if ( $mystatus == 0 ) then
     set compile = `tail -1 $out |awk '{print $NF}'`
     echo Compiling $compile
     $compile >>& $out
     set mystatus = $status
     if ( $mystatus == 0 ) then
        echo $expt compiled OK
     else
        echo Compile failed for $expt
        tail $out
        echo See $out
        set mkstatus = 100
     endif
  else if ( $mystatus == 23 ) then
     echo "A pre-compiled executable has been specified for $expt (status $mystatus)"
  else if ( $mystatus == 41 ) then
     echo "$expt does not need to be compiled (status $mystatus)"
  else
     echo "fremake failed for $expt (status $mystatus)"
     tail $out
     echo See $out
     set mkstatus = 100
  endif
end

cd
rm -rf $TMPDIR

EOF
   return $csh;
}

sub getruntemplate {
   my $csh = <<'EOF';

#set up temporary directory
if ( ! $?TMPDIR ) set TMPDIR = "$outdir"
set TMPDIR = "$TMPDIR/run.tmp.$thisdate"
if ( -d $TMPDIR ) then
   rm -rf $TMPDIR/* >& /dev/null
else
   mkdir -p $TMPDIR
endif

cd $TMPDIR
if ( -f $outdir/$xml ) then
  cp $outdir/$xml .
else
  echo "FATAL: Cannot find xml file $outdir/$xml"
  exit 1
endif

set list = ( `frelist -p $platform -x $xml |grep -v INHERITS` )
set list = ( $list `frelist -p $platform -x $xml |grep INHERITS |cut -f1 -d\ ` )

set rootdir = `frelist -p $platform -dir=root -t repro -x $xml $list[1]`
if ( ! -d $rootdir ) then
  mkdir -p $rootdir || exit 1
endif
cp $xml $rootdir

foreach expt ( $list )
  set cmd = "frerun -p $platform -t repro -r $regtype -x $xml $expt"
  set dirs = (`frelist -p $platform -dir -t repro -x $xml $expt | egrep '^root:|^stdout:|^work:'`)
  set stdoutdir = (`echo $dirs | awk '{print $4}'`)
  set workdir = (`echo $dirs | awk '{print $6}'`)
  set out = $stdoutdir/run_$expt.stdout
  set runs = () 
  echo ---------------------------------------------------
  echo $cmd
  $cmd >& $out 
  set mystatus = $status
  if ( $mystatus == 0 ) then
     set runs = ( `grep 'TO SUBMIT' $out | awk '{print $NF}'` )
     foreach run ( $runs )
        echo Running $run
        $run >>& $out
        set mystatus = $status
        if ( $mystatus == 0 ) then
           echo $expt ran OK
        else
           echo Run failed for $expt
           tail $out
           echo See $out
        endif
        rm -rf $workdir
     end
  else
     echo "frerun failed for $expt (status $mystatus)"
     tail $out
     echo See $out
  endif
end

echo ---------------------------------------------------
set cmd = "frecheck -p $platform -t repro -x $xml $list"
echo $cmd

$cmd > stdoutfile
if ( $status == 0 ) then
   set result = 'passed'
else
   set result = 'FAILED'
endif
cat stdoutfile
echo Result of frerts for ${thisdate}: $result

cat > "$rootdir/autoRTS.check.$thisdate" << END
Result of frerts for ${thisdate}: $result

Experiments tested: $list
XML file: $rootdir/$xml
Output in $rootdir
END
tail -10 stdoutfile >> $rootdir/autoRTS.check.$thisdate
echo "Full results of frecheck:" >> $rootdir/autoRTS.check.$thisdate
cat stdoutfile >> $rootdir/autoRTS.check.$thisdate
set logdir = $outdir:h
touch $logdir/log
echo "$thisdate $result $rootdir/$xml" >> $logdir/log

Mail -s "frerts results for ${thisdate}: $result" $USER < $rootdir/autoRTS.check.$thisdate
sleep 30

cd
rm -rf $TMPDIR

EOF
   return $csh;
}

sub writescript {
   #my $script = $_[0];
   my $fre = $_[1];
   my $outscript = $_[2];
   my $batchCmd = $_[3];
   my $submit = $_[4];
   my $verbose = $_[5];
   my $batchonly = $_[6];

   (my $volume,my $directory,my $filename) = File::Spec->splitpath( $outscript );
   if( ! -e $directory ) { mkdir $directory || die "Cannot make directory $directory\n"; }

   open(OUT,"> $outscript");
   print OUT $_[0];
   close(OUT);

   my $status = system("chmod 755 $outscript");
   if( $status ) { die "Sorry, I couldn't chmod $outscript"; }

   if( $submit ) {
      if($verbose){print "\nExecuting '$batchCmd $outscript'\n";}
      my $qsub_msg = `$batchCmd $outscript`;
      print "\n$qsub_msg";
      my $qsubOutputPattern = $fre->property('FRE.scheduler.qsub.output.pattern');
      return ($qsub_msg =~ m/$qsubOutputPattern/m) ? $1 : '';
   } else {
      unless ($batchonly) {
         print "\nINTERACTIVE ONLY: $outscript\n";
      }
   }
}

