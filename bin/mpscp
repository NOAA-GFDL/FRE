#!/bin/csh -f
#wrapper by Amy, could use review by others!

unalias *
set MPSCP = /app/mpscp-1.3a/bin/mpscp
set returnstatus = 0

source $MODULESHOME/init/csh
module load globus

set srclist = (` echo $argv | awk '{ for (i=1; i<NF; i++) print $i }' `)

set dest = `echo $argv | awk '{ print $NF }'`
set firstchar = `echo $dest | cut -c1`
if ( "$firstchar" != "/" ) set dest = "$cwd/$dest"

set qualdest = "$dest"
set destfs = `echo $dest |cut -f2 -d/`


foreach src ( $srclist )

   set firstchar = `echo $src | cut -c1`
   if ( "$firstchar" != "/" ) set src = "$cwd/$src"

   set qualsrc = "$src"
   set srcfs = `echo $src |cut -f2 -d/`

   foreach server ( cdtn.lb.princeton.rdhpcs.noaa.gov nfs01 nfs03 nfs04 )

     if ( `echo $srcfs | cut -c 1-4` == "arch" ) set qualsrc = "$server":"$src"
     if ( `echo $destfs | cut -c 1-4` == "arch" ) set qualdest = "$server":"$dest"

     echo "$MPSCP -m $MPSCP -S gsissh -w 4 -b 8388608 $qualsrc $qualdest"
     $MPSCP -m $MPSCP -S gsissh -w 4 -b 8388608 $qualsrc $qualdest
     if ( $status ) then
        set cpstatus = 1
        sleep 10
     else 
        set cpstatus = 0
        break
     endif

   end

   if ( $cpstatus ) then 
      echo "mcp --buffer-size=1 $src $dest"
      mcp --buffer-size=1 $src $dest
      if ( $status ) then
         echo ERROR: FILE COULD NOT BE COPIED: $src
         set returnstatus = 1
      endif
   endif

end 

exit $returnstatus
