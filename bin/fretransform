#!/usr/bin/perl
# -*- cperl -*-
#substitute autoRTS directories
#usage: fretransform -x xmlfile > outfile
use Getopt::Long;
use FRE();


use strict;

#get a datestring to use to create a unique path
my $thisdate = `date '+%Y%m%d_%H%M%S'`;
chomp $thisdate;

#get options
use constant VERSION => '$Id: fretransform,v 15.1.2.8.2.2 2011/03/09 18:19:35 sdu Exp $';
use constant OPTLIST =>
  (
      'help|h',
      'datestr|d=s',
      'platform|Platform|P=s',
      'xmlfile|x=s',
  );
my %opt = (
     'xmlfile'   => FREDefaults::XMLFile(),
     'datestr'   => $thisdate
  );
Getopt::Long::GetOptions(\%opt,OPTLIST) or die "FATAL: can't parse command line options\n";

if( ! -f $opt{xmlfile} and ! $opt{help} ) {
  print "FATAL: XML file does not exist: $opt{xmlfile}\n"; 
  $opt{help}=1;
}

#help message
if( $opt{help} ) {
   print <<EOF;
Synopsis: substitute autoRTS directories
Usage:    fretransform -d str -p platform -x xmlfile > out.xml
  [-d str] is optional and specifies a string to use in file paths
  instead of a date string.
EOF
   exit 1;
}

#get access to fre.properties
my $fre = FRE->new('frerts', %opt) or die "Cannot initiate FRE";
my $autoRTSroot = $fre->property('FRE.autoRTS.root.prefix')."/$opt{datestr}";
my $autoRTSarchive = $fre->property('FRE.autoRTS.archive.prefix')."/$opt{datestr}";
my $site = $fre->property('site');

#create xsl to replace the directory names with "autoRTS" directories
my $xsl = <<EOF;
<xsl:stylesheet version="1.0"
      xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
   <xsl:output method="xml" cdata-section-elements="csh"/>

   <xsl:template match="node()|@*">
     <xsl:copy>
     <xsl:apply-templates select="@*"/>
     <xsl:apply-templates/>
     </xsl:copy>
   </xsl:template>

   <xsl:template match="property[\@name='FRE_STEM']">
            <property name="FRE_STEM" value="autoRTS/$opt{datestr}"/>
   </xsl:template>

   <xsl:template match="platform[\@name[starts-with(.,'$site.')]]/directory[\@type='root']">
            <directory type="root">$autoRTSroot</directory>
   </xsl:template>

   <xsl:template match="platform[\@name[starts-with(.,'$site.')]]/directory[\@type='src']">
            <directory type="src">\$(rootDir)/\$(name)/src</directory>
   </xsl:template>

   <xsl:template match="platform[\@name[starts-with(.,'$site.')]]/directory[\@type='scripts']">
            <directory type="scripts">\$(rootDir)/\$(name)/\$(platform)-\$(target)/scripts</directory>
   </xsl:template>

   <xsl:template match="platform[\@name[starts-with(.,'$site.')]]/directory[\@type='stdout']">
            <directory type="stdout">\$(rootDir)/\$(name)/\$(platform)-\$(target)/stdout</directory>
   </xsl:template>

   <xsl:template match="platform[\@name[starts-with(.,'$site.')]]/directory[\@type='exec']">
            <directory type="exec">\$(rootDir)/\$(name)/\$(platform)-\$(target)/exec</directory>
   </xsl:template>

   <xsl:template match="platform[\@name[starts-with(.,'$site.')]]/directory[\@type='archive']">
            <directory type="archive">$autoRTSarchive/\$(name)/\$(platform)-\$(target)</directory>
   </xsl:template>

   <xsl:template match="platform[\@name[starts-with(.,'$site.')]]/directory[\@type='work']">
            
   </xsl:template>

   <xsl:template match="platform[\@name[starts-with(.,'$site.')]]/directory[\@type='ptmp']">
           
   </xsl:template>

   <xsl:template match="platform[\@name[starts-with(.,'$site.')]]/directory[not(@*)]">
         <directory>
           <root>$autoRTSroot</root>
           <src>\$(rootDir)/\$(name)/src</src>
           <scripts>\$(rootDir)/\$(name)/\$(platform)-\$(target)/scripts</scripts>
           <stdout>\$(rootDir)/\$(name)/\$(platform)-\$(target)/stdout</stdout>
           <exec>\$(rootDir)/\$(name)/\$(platform)-\$(target)/exec</exec>
           <archive>$autoRTSarchive/\$(name)/\$(platform)-\$(target)</archive>
         </directory>
   </xsl:template>

</xsl:stylesheet>
EOF

#set up temporary directory, write xsl to file
my $workdir = "/tmp/fretransform_$ENV{USER}_$opt{datestr}";
if ($ENV{TMPDIR}) { $workdir = "$ENV{TMPDIR}/fretransform_$ENV{USER}_$opt{datestr}"; }
mkdir $workdir or die "FATAL: can't make temporary dir $workdir";
my $out = "$workdir/TMP-AUTORTS.xml";
my $xslfile = "$workdir/TMP-AUTORTS.xsl";
open(XSLFILE, ">$xslfile") or die "FATAL: can't open xsl file $xslfile";
print XSLFILE "$xsl\n";
close(XSLFILE);

#do the xsl transformation and call xmllint to indent the file
system("xsltproc $xslfile $opt{xmlfile} > $out");
system("xmllint --format $out");

#remove temporary stuff
unlink $out;
unlink $xslfile;
rmdir $workdir;

exit 0;



